<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TalkUp English</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { padding-top: 70px; font-family: Arial, sans-serif; }
.hidden { display: none; }
@keyframes rainbow { 0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;} }
.home-bg { background: linear-gradient(-45deg, red, orange, yellow, green, blue, indigo, violet); background-size: 400% 400%; animation: rainbow 15s ease infinite; color: white; min-height: 100vh; }
.logo { width:120px; animation: bounce 2s infinite; }
@keyframes bounce { 0%,20%,50%,80%,100%{transform:translateY(0);}40%{transform:translateY(-20px);}60%{transform:translateY(-10px);} }
.teacher-box { border-radius:15px;border:3px solid #fff;padding:10px;cursor:pointer;transition:transform 0.3s;min-height:180px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);}
.teacher-box:hover { transform: scale(1.05); }
.teacher-box img { width:100%;border-radius:10px; }
.teacher-desc { font-size:0.75rem; display:none; white-space:pre-wrap; }
.teacher-name { font-size:0.9rem;font-weight:bold;margin-top:5px; }
.btn-book { font-size:1.2rem;padding:10px 30px;font-weight:bold;border-radius:50px;color:#fff;border:none;background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);}
</style>
</head>
<!-- ================== NOTIFICATION CENTER ================== -->
<div id="notificationCenter" class="hidden p-3 container" style="max-width:400px; position:fixed; top:70px; right:20px; z-index:1050; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
  <h5>ğŸ”” Notifications</h5>
  <ul id="notificationList" class="list-group list-group-flush"></ul>
  <button class="btn btn-sm btn-secondary mt-2 w-100" onclick="clearNotifications()">Clear All</button>
</div>

<script>
// ================== NOTIFICATION CENTER LOGIC ==================
let notificationLog = loadData("notificationLog") || [];

// Show/Hide notification center (can add toggle button)
function toggleNotificationCenter() {
  const center = document.getElementById("notificationCenter");
  center.classList.toggle("hidden");
}

// Add a notification to the center
function addNotificationCenter(message, page = "", type = "info") {
  const notif = { message, page, type, time: new Date().toISOString(), read: false };
  notificationLog.push(notif);
  saveData("notificationLog", notificationLog);
  renderNotifications();
}

// Render notifications feed
function renderNotifications() {
  const list = document.getElementById("notificationList");
  list.innerHTML = "";

  notificationLog.slice().reverse().forEach((notif, idx) => {
    const li = document.createElement("li");
    li.className = `list-group-item list-group-item-${notif.type} d-flex justify-content-between align-items-start`;
    li.style.cursor = notif.page ? "pointer" : "default";
    li.innerHTML = `
      <div>
        <div class="fw-bold">${notif.read ? "" : "ğŸ”µ "} ${notif.message}</div>
        <small class="text-muted">${new Date(notif.time).toLocaleString()}</small>
      </div>
      <span class="badge bg-primary rounded-pill">${notif.read ? "âœ“" : "New"}</span>
    `;
    li.addEventListener("click", () => {
      if(notif.page) showPage(notif.page);
      notif.read = true;
      saveData("notificationLog", notificationLog);
      renderNotifications();
    });
    list.appendChild(li);
  });
}

// Clear all notifications
function clearNotifications() {
  notificationLog = [];
  saveData("notificationLog", notificationLog);
  renderNotifications();
}

// ================== EVENT INTEGRATION ==================
// Trial booking event
document.getElementById("trialForm").addEventListener("submit", e => {
  e.preventDefault();
  const parent = parentName.value;
  const student = studentName.value;
  const assigned = autoAssignTeacher(["Teacher Ann", "Teacher John", "Teacher Lisa", "Teacher Mark"]);

  const trial = { parent, student, assignedTeacher: assigned, status: "Assigned" };
  trialLog.push(trial);
  saveData("trialLog", trialLog);

  trialMessage.innerHTML = `Trial booked âœ” Assigned to <b>${assigned}</b>`;

  // Add notification
  addNotificationCenter(`Trial booked: ${student} â†’ ${assigned} (Parent: ${parent})`, "trial", "success");
  e.target.reset();
});

// Attendance event
document.getElementById("attendanceForm").addEventListener("submit", e => {
  e.preventDefault();
  const record = {
    teacher: attTeacher.value,
    student: attStudent.value,
    date: attDate.value,
    status: attStatus.value,
    time: attTime.value,
    notes: attNotes.value
  };
  attendanceLog.push(record);
  saveData("attendanceLog", attendanceLog);

  updateAttendanceScore(record.teacher);
  attendanceMsg.innerText = "Attendance saved âœ”";

  // Add notification
  addNotificationCenter(`Attendance recorded: ${record.student} (${record.status}) - Teacher: ${record.teacher}`, "attendanceSheet", "info");
  e.target.reset();
});

// Payment event
function addPayment(student, amount, status="Completed") {
  const payment = { student, amount, status, date: new Date().toLocaleDateString() };
  paymentLog.push(payment);
  saveData("paymentLog", paymentLog);

  // Add notification
  addNotificationCenter(`Payment ${status}: ${student} paid $${amount}`, "dashboard", "warning");
}

// Load existing notifications on dashboard load
document.addEventListener("DOMContentLoaded", () => {
  renderNotifications();
});

</script>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-primary fixed-top">
<div class="container">
<a class="navbar-brand" href="javascript:void(0)" onclick="showPage('home')">TalkUp English</a>

<ul class="navbar-nav flex-row gap-3">
<li class="nav-item"><span class="nav-link text-white" onclick="showPage('home')">Home</span></li>
<li class="nav-item"><span class="nav-link text-white" onclick="showPage('trial')">Trial Class Booking</span></li>
<li class="nav-item"><span class="nav-link text-white" onclick="showPage('teachers')">Teachers</span></li>
<li class="nav-item"><span class="nav-link text-white" onclick="showPage('dashboard')">Dashboard</span></li>
</ul>

<div class="dropdown ms-3">
<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">â˜°</button>
<ul class="dropdown-menu dropdown-menu-end p-2" style="width:320px">
<li class="dropdown-item small" onclick="showPage('attendanceSheet')">ğŸ“‹ Attendance Sheet</li>
<li class="dropdown-item small admin-only" onclick="showPage('trialAssign')">ğŸ¯ Trial Class Assignment (Admin)</li>
<li class="dropdown-item small" onclick="showPage('attendanceTracking')">ğŸ“Š Attendance Tracking</li>
<li class="dropdown-item small admin-only" onclick="showPage('absenceOverview')">âš ï¸ Teacher Absence Overview</li>
<li class="dropdown-item small" onclick="showPage('parentDashboard')">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Dashboard</li>
<li class="dropdown-item small" onclick="showPage('teacherDashboard')">ğŸ‘©â€ğŸ« Teacher Dashboard</li>
</ul>
</div>
</div>
</nav>

<button class="btn btn-outline-primary admin-only" onclick="exportAttendanceCSV()">Export Attendance</button>

<div class="container-fluid">
<!-- HOME -->
<div id="home" class="home-bg p-4">
  <div class="row">
    <div class="col-md-9 text-center p-5">
      <img src="logo.png" class="logo mb-3">
      <h2>TalkUp English: Speak Up, Stand Out!</h2>
      <p class="mb-3">Book a Fun English Class</p>
      <a href="booking.html" class="btn btn-book mb-4">Book Now</a>
      <div><p>For further inquiries, connect via WeChat</p><img src="wechat.png" width="150" class="rounded border border-light"></div>
    </div>
    <div class="col-md-3 p-4" style="background:rgba(0,0,0,0.25)">
      <h4 class="mb-4">ğŸ‘©â€ğŸ« Our Teachers</h4>
      <div class="row g-3 text-center">
        <div class="col-6"><div class="teacher-box" onclick="toggleProfile(this)"><img src="profile.jpeg"><div class="teacher-desc">ğŸ‘©â€ğŸ« Teacher Ann ...</div></div><div class="teacher-name">Teacher Ann</div></div>
        <div class="col-6"><div class="teacher-box" onclick="toggleProfile(this)"><img src="teacher-john.png"><div class="teacher-desc">ğŸ‘¨â€ğŸ« Teacher John ...</div></div><div class="teacher-name">Teacher John</div></div>
        <div class="col-6"><div class="teacher-box" onclick="toggleProfile(this)"><img src="teacher-lisa.png"><div class="teacher-desc">ğŸ‘©â€ğŸ« Teacher Lisa ...</div></div><div class="teacher-name">Teacher Lisa</div></div>
        <div class="col-6"><div class="teacher-box" onclick="toggleProfile(this)"><img src="teacher-mark.png"><div class="teacher-desc">ğŸ‘¨â€ğŸ« Teacher Mark ...</div></div><div class="teacher-name">Teacher Mark</div></div>
      </div>
    </div>
  </div>
</div>

<!-- TRIAL -->
<div id="trial" class="hidden p-4 container">
  <h2>Trial Class Booking</h2>
  <form id="trialForm">
    <input class="form-control mb-2" id="parentName" placeholder="Parent Name" required>
    <input class="form-control mb-2" id="studentName" placeholder="Student Name" required>
    <input class="form-control mb-2" id="email" type="email" placeholder="Email" required>
    <input class="form-control mb-2" id="phone" placeholder="Phone" required>
    <input class="form-control mb-2" id="preferredTeacher" placeholder="Preferred Teacher (Optional)">
    <button class="btn btn-primary">Book Trial</button>
  </form>
  <div id="trialMessage" class="mt-3"></div>
</div>

<!-- TEACHERS -->
<div id="teachers" class="hidden p-4 container">
  <h2>Our Teachers</h2>
  <ul>
    <li>Teacher Ann â€“ IELTS & Kids</li>
    <li>Teacher John â€“ IELTS Specialist</li>
    <li>Teacher Lisa â€“ Kids English</li>
    <li>Teacher Mark â€“ Business English</li>
  </ul>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="hidden p-4 container">
  <h2>Dashboard</h2>
  <select id="roleSelect" class="form-select mb-2">
    <option value="">Select Role</option>
    <option value="parent">Parent</option>
    <option value="teacher">Teacher</option>
    <option value="admin">Admin</option>
  </select>
  <input id="nameInput" class="form-control mb-2" placeholder="Enter Name">
  <button class="btn btn-success" onclick="loadDashboard()">Load Dashboard</button>
  <div id="dashboardContent" class="mt-3"></div>
</div>

<!-- ATTENDANCE SHEET -->
<div id="attendanceSheet" class="hidden p-4 container">
  <h3>ğŸ“‹ Attendance Sheet</h3>
  <form id="attendanceForm">
    <input class="form-control mb-2" id="attTeacher" placeholder="Teacher Name" required>
    <input class="form-control mb-2" id="attStudent" placeholder="Student Name" required>
    <input class="form-control mb-2" type="date" id="attDate" required>
    <select class="form-select mb-2" id="attStatus">
      <option value="conducted">Conducted</option>
      <option value="teacherAbsent">Teacher Absent</option>
      <option value="studentAbsent">Student Absent</option>
      <option value="late">Late / No Show</option>
      <option value="makeup">Make-up Class</option>
    </select>
    <input class="form-control mb-2" type="time" id="attTime">
    <textarea class="form-control mb-2" id="attNotes" placeholder="Notes"></textarea>
    <button class="btn btn-success">Save Attendance</button>
  </form>
  <div id="attendanceMsg" class="mt-3"></div>
</div>

<!-- TRIAL ASSIGN -->
<div id="trialAssign" class="hidden p-4 container admin-only">
  <h3>ğŸ¯ Trial Class Assignment</h3>
  <input class="form-control mb-2" placeholder="Student Name">
  <input class="form-control mb-2" placeholder="Assigned Teacher">
  <button class="btn btn-primary">Assign Teacher</button>
</div>

<!-- ATTENDANCE TRACKING -->
<div id="attendanceTracking" class="hidden p-4 container">
  <h3>ğŸ“Š Attendance Tracking</h3>
  <ul>
    <li>Conducted</li>
    <li>Teacher Absent</li>
    <li>Student Absent</li>
    <li>Late / No Show</li>
    <li>Make-up Classes</li>
  </ul>
</div>

<!-- ABSENCE OVERVIEW -->
<div id="absenceOverview" class="hidden p-4 container admin-only">
  <h3>âš ï¸ Teacher Absence Overview</h3>
  <table class="table table-bordered">
    <thead>
      <tr><th>Teacher</th><th>Teacher Absent</th><th>Late / No-show</th><th>Risk Level</th></tr>
    </thead>
    <tbody id="absenceTable"></tbody>
  </table>
</div>

<!-- TEACHER DASHBOARD -->
<div id="teacherDashboard" class="hidden p-4 container">
  <h3>ğŸ‘©â€ğŸ« Teacher Dashboard</h3>
  <p><strong>Attendance Score:</strong> <span id="attendanceScore">100%</span></p>
  <p>Parent Feedback: â­â­â­â­â˜†</p>
  <p>Trial Conversion Rate: 60%</p>
</div>

</div>
<!-- ================== PARENT DASHBOARD ================== -->
<div id="parentDashboardSection" class="hidden p-4 container">
  <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Dashboard</h3>
  <div id="parentTrials" class="mb-3"></div>
  <div id="parentPayments" class="mb-3"></div>
  <div id="parentFeedback" class="mb-3"></div>
</div>

<!-- ================== TEACHER DASHBOARD ================== -->
<div id="teacherDashboardSection" class="hidden p-4 container">
  <h3>ğŸ‘©â€ğŸ« Teacher Dashboard</h3>
  <p><strong>Attendance Score:</strong> <span id="teacherAttendanceScore">100%</span></p>
  <p><strong>Payroll:</strong> $<span id="teacherPayroll">0</span></p>
  <div id="teacherTrials" class="mb-3"></div>
  <div id="teacherFeedback" class="mb-3"></div>
</div>

<script>
// ================== DASHBOARD RENDERING ==================
function renderParentDashboard(parentName) {
  const trials = trialLog.filter(t => t.parent === parentName);
  const payments = paymentLog.filter(p => trials.some(trial => trial.student === p.student));
  const feedbacks = feedbackLog.filter(f => trials.some(trial => trial.student === f.student));

  // Trials
  let trialHTML = "<h5>Trial Classes</h5><ul>";
  trials.forEach(t => {
    trialHTML += `<li>${t.student} â€“ Assigned Teacher: ${t.assignedTeacher} â€“ Status: ${t.status}</li>`;
  });
  trialHTML += "</ul>";
  parentTrials.innerHTML = trialHTML;

  // Payments
  let paymentHTML = "<h5>Payment Status</h5><ul>";
  payments.forEach(p => {
    paymentHTML += `<li>${p.student} â€“ $${p.amount} â€“ ${p.status} (${p.date})</li>`;
  });
  paymentHTML += "</ul>";
  parentPayments.innerHTML = paymentHTML;

  // Feedback
  let feedbackHTML = "<h5>Feedback Summary</h5><ul>";
  feedbacks.forEach(f => {
    feedbackHTML += `<li>${f.student} â€“ ${f.teacher}: "${f.feedbackText}" (Score: ${f.sentimentScore})</li>`;
  });
  feedbackHTML += "</ul>";
  parentFeedback.innerHTML = feedbackHTML;

  // Show section
  parentDashboardSection.classList.remove("hidden");
  teacherDashboardSection.classList.add("hidden");
}

// ================== TEACHER DASHBOARD ==================
function renderTeacherDashboard(teacherName) {
  // Attendance
  const score = 100 - getTeacherScore(teacherName);
  teacherAttendanceScore.innerText = score;

  // Payroll
  const payroll = calculateTeacherPayroll(teacherName);
  teacherPayroll.innerText = payroll;

  // Trial Classes assigned
  const trials = trialLog.filter(t => t.assignedTeacher === teacherName);
  let trialsHTML = "<h5>Trial Classes Assigned</h5><ul>";
  trials.forEach(t => {
    trialsHTML += `<li>${t.student} â€“ Parent: ${t.parent} â€“ Status: ${t.status}</li>`;
  });
  trialsHTML += "</ul>";
  teacherTrials.innerHTML = trialsHTML;

  // Feedback
  const feedbacks = feedbackLog.filter(f => f.teacher === teacherName);
  const summary = getFeedbackSummary(teacherName);
  let feedbackHTML = `<h5>Feedback Summary</h5>
    <p>Positive: ${summary.positive} | Neutral: ${summary.neutral} | Negative: ${summary.negative}</p>
    <ul>`;
  feedbacks.forEach(f => {
    feedbackHTML += `<li>${f.student}: "${f.feedbackText}" (Score: ${f.sentimentScore})</li>`;
  });
  feedbackHTML += "</ul>";
  teacherFeedback.innerHTML = feedbackHTML;

  // Show section
  teacherDashboardSection.classList.remove("hidden");
  parentDashboardSection.classList.add("hidden");
}

// ================== DASHBOARD LOADER ==================
function loadDashboard() {
  const role = roleSelect.value;
  const name = nameInput.value.trim();
  if(!role || !name) return alert("Select role and enter name");

  applyRole(role);
  dashboardContent.innerHTML = `<p>Welcome ${name} (${role})</p>`;

  if(role === "parent") renderParentDashboard(name);
  if(role === "teacher") renderTeacherDashboard(name);
  if(role === "admin") {
    loadAbsenceOverview();
    parentDashboardSection.classList.add("hidden");
    teacherDashboardSection.classList.add("hidden");
  }
}

// ================== EXAMPLES ==================
// Uncomment to test
// bookTrial("Parent A", "Student X", ["Teacher Lisa"]);
// addPayment("Student X", 50, "2025-12-20");
// addFeedback("Student X", "Teacher Lisa", "Great teacher, very patient!");
</script>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ---------- GLOBAL ----------
let attendanceLog = [];
let trialLog = [];
let currentRole = "";

// ---------- SHOW PAGE ----------
function showPage(page){
  document.querySelectorAll('#home,#trial,#teachers,#dashboard,#attendanceSheet,#trialAssign,#attendanceTracking,#absenceOverview,#teacherDashboard')
  .forEach(p=>p.classList.add('hidden'));
  document.getElementById(page).classList.remove('hidden');
}

// ---------- DASHBOARD ----------
function loadDashboard(){
  const role = roleSelect.value;
  const name = nameInput.value.trim();
  if(!role||!name)return alert("Select role and enter name");
  currentRole = role;
  dashboardContent.innerHTML = `<p>Welcome ${name} (${role})</p>`;
  document.querySelectorAll(".admin-only").forEach(el=>el.style.display=role==="admin"?"block":"none");
}

// ---------- TEACHER PROFILE ----------
function toggleProfile(card){
  const img=card.querySelector("img");
  const desc=card.querySelector(".teacher-desc");
  img.style.display=img.style.display==="none"?"block":"none";
  desc.style.display=desc.style.display==="block"?"none":"block";
}

// ---------- ATTENDANCE ----------
document.getElementById("attendanceForm").addEventListener("submit",e=>{
  e.preventDefault();
  const record={teacher:attTeacher.value,student:attStudent.value,date:attDate.value,status:attStatus.value,time:attTime.value,notes:attNotes.value};
  attendanceLog.push(record);
  saveData("attendanceLog",attendanceLog);
  updateAttendanceScore();
  attendanceMsg.innerText="Attendance saved âœ”";
  e.target.reset();
  loadAbsenceOverview();
});

function updateAttendanceScore(){
  let score=100;
  attendanceLog.forEach(s=>{
    if(s.status==="teacherAbsent")score-=20;
    if(s.status==="late")score-=10;
    if(s.status==="studentAbsent")score-=5;
  });
  score=Math.max(score,0);
  document.getElementById("attendanceScore").innerText=score+"%";
}

// ---------- TRIAL FORM ----------
document.getElementById("trialForm").addEventListener("submit",e=>{
  e.preventDefault();
  const teachers=["Teacher Ann","Teacher John","Teacher Lisa","Teacher Mark"];
  const assigned=autoAssignTeacher(teachers);
  const trial={parent:parentName.value,student:studentName.value,assignedTeacher:assigned,status:"Assigned"};
  trialLog.push(trial);
  saveData("trialLog",trialLog);
  trialMessage.innerHTML=`Trial booked âœ” Assigned to <b>${assigned}</b>`;
  e.target.reset();
});

// ---------- AUTO ASSIGN ----------
function getTeacherScore(teacher){
  const records=attendanceLog.filter(r=>r.teacher===teacher);
  let penalty=0;
  records.forEach(r=>{if(r.status==="teacherAbsent")penalty+=20;if(r.status==="late")penalty+=10;});
  return penalty;
}
function autoAssignTeacher(teachers){
  return teachers.map(t=>({name:t,score:getTeacherScore(t)})).sort((a,b)=>a.score-b.score)[0].name;
}

// ---------- EXPORT CSV ----------
function exportAttendanceCSV(){
  let csv="Teacher,Student,Date,Status,Time,Notes\n";
  attendanceLog.forEach(r=>{csv+=`${r.teacher},${r.student},${r.date},${r.status},${r.time},${r.notes}\n`;});
  const blob=new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="attendance_report.csv";
  link.click();
}

// ---------- LOCAL STORAGE ----------
function saveData(key,data){localStorage.setItem(key,JSON.stringify(data));}
function loadData(key){return JSON.parse(localStorage.getItem(key))||[];}
attendanceLog=loadData("attendanceLog");
trialLog=loadData("trialLog");

// ---------- ABSENCE OVERVIEW ----------
function loadAbsenceOverview(){
  const stats={};
  attendanceLog.forEach(r=>{
    if(!stats[r.teacher])stats[r.teacher]={absent:0,late:0};
    if(r.status==="teacherAbsent")stats[r.teacher].absent++;
    if(r.status==="late")stats[r.teacher].late++;
  });
  const tbody=document.getElementById("absenceTable");
  tbody.innerHTML="";
  for(let t in stats){
    const risk=(stats[t].absent>=3||stats[t].late>=3)?"ğŸ”´ Risky":"ğŸŸ¢ Reliable";
    tbody.innerHTML+=`<tr><td>${t}</td><td>${stats[t].absent}</td><td>${stats[t].late}</td><td>${risk}</td></tr>`;
  }
}

// ---------- NOTIFICATIONS ----------
function notifyParent(message){if(Notification.permission==="granted"){new Notification("TalkUp English",{body:message});}}
Notification.requestPermission();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"YOUR_KEY",
  authDomain:"YOUR_PROJECT.firebaseapp.com",
  projectId:"YOUR_PROJECT"
};

export const app=initializeApp(firebaseConfig);
export const auth=getAuth(app);
export const db=getFirestore(app);
</script>
<script>
// ================== GLOBAL DATA ==================
let attendanceLog = loadData("attendanceLog");
let trialLog = loadData("trialLog");
let paymentLog = loadData("paymentLog");
let feedbackLog = loadData("feedbackLog");
let currentRole = "";

// ================== ROLE CONTROL ==================
function applyRole(role) {
  currentRole = role;
  document.querySelectorAll(".admin-only").forEach(el =>
    el.style.display = role === "admin" ? "block" : "none"
  );
}

// ================== NOTIFICATIONS ==================
function sendNotification(to, type, message) {
  if(type === "email") {
    console.log(`Email sent to ${to}: ${message}`);
  } else if(type === "wechat") {
    console.log(`WeChat message sent to ${to}: ${message}`);
  }
}

// ================== TRIAL CLASS ==================
function autoAssignTeacher(teachers, preferences=[]) {
  // AI-based matching: minimize penalty + match preferences
  return teachers
    .map(t => {
      const score = getTeacherScore(t);
      const preferenceMatch = preferences.includes(t) ? 10 : 0;
      return {name: t, totalScore: score - preferenceMatch};
    })
    .sort((a,b) => a.totalScore - b.totalScore)[0].name;
}

function bookTrial(parentName, studentName, preferredTeachers = []) {
  const teachers = ["Teacher Ann","Teacher John","Teacher Lisa","Teacher Mark"];
  const assigned = autoAssignTeacher(teachers, preferredTeachers);

  const trial = {
    parent: parentName,
    student: studentName,
    assignedTeacher: assigned,
    status: "Assigned"
  };
  trialLog.push(trial);
  saveData("trialLog", trialLog);

  // Notify parent and teacher
  sendNotification(parentName, "email", `Your trial class is scheduled with ${assigned}`);
  sendNotification(assigned, "wechat", `You have a new trial class for student ${studentName}`);

  return assigned;
}

// ================== ATTENDANCE ==================
function saveAttendance(teacher, student, date, status, time, notes) {
  const record = {teacher, student, date, status, time, notes};
  attendanceLog.push(record);
  saveData("attendanceLog", attendanceLog);

  // Update teacher score
  updateAttendanceScore(teacher);
}

// Teacher scoring
function getTeacherScore(teacher) {
  const records = attendanceLog.filter(r => r.teacher === teacher);
  let penalty = 0;
  records.forEach(r => {
    if(r.status === "teacherAbsent") penalty += 20;
    if(r.status === "late") penalty += 10;
    if(r.status === "studentAbsent") penalty += 5;
  });
  return penalty;
}

function updateAttendanceScore(teacher) {
  let score = 100 - getTeacherScore(teacher);
  score = Math.max(0, score);
  const el = document.getElementById("attendanceScore");
  if(el) el.innerText = score + "%";
}

// ================== PAYMENT TRACKING ==================
function addPayment(student, amount, date, status="Paid") {
  paymentLog.push({student, amount, date, status});
  saveData("paymentLog", paymentLog);
}

function getPaymentStatus(student) {
  return paymentLog.filter(p => p.student === student);
}

// ================== TEACHER PAYROLL ==================
function calculateTeacherPayroll(teacher, ratePerClass=20) {
  const records = attendanceLog.filter(r => r.teacher === teacher);
  let total = 0;
  records.forEach(r => {
    if(r.status === "conducted") total += ratePerClass;
    if(r.status === "teacherAbsent") total -= 10; // deduction
  });
  return total;
}

// ================== FEEDBACK SENTIMENT ==================
function addFeedback(student, teacher, text) {
  const sentimentScore = analyzeSentiment(text);
  feedbackLog.push({student, teacher, feedbackText:text, sentimentScore});
  saveData("feedbackLog", feedbackLog);
}

function analyzeSentiment(text){
  const positive=["good","great","excellent","happy","love","awesome"];
  const negative=["bad","poor","late","disappoint","hate","terrible"];
  let score=0;
  text=text.toLowerCase();
  positive.forEach(w=>{if(text.includes(w)) score+=1;});
  negative.forEach(w=>{if(text.includes(w)) score-=1;});
  return score;
}

function getFeedbackSummary(teacher){
  const feedbacks = feedbackLog.filter(f=>f.teacher===teacher);
  const summary = {positive:0, neutral:0, negative:0};
  feedbacks.forEach(f=>{
    if(f.sentimentScore>0) summary.positive++;
    else if(f.sentimentScore<0) summary.negative++;
    else summary.neutral++;
  });
  return summary;
}

// ================== ABSENCE OVERVIEW ==================
function loadAbsenceOverview() {
  const stats = {};
  attendanceLog.forEach(r => {
    if(!stats[r.teacher]) stats[r.teacher] = {absent:0, late:0};
    if(r.status === "teacherAbsent") stats[r.teacher].absent++;
    if(r.status === "late") stats[r.teacher].late++;
  });

  const tbody = document.getElementById("absenceTable");
  tbody.innerHTML = "";

  for(let t in stats){
    const risk = stats[t].absent>=3 || stats[t].late>=3 ? "ğŸ”´ Risky" : "ğŸŸ¢ Reliable";
    tbody.innerHTML += `
      <tr>
        <td>${t}</td>
        <td>${stats[t].absent}</td>
        <td>${stats[t].late}</td>
        <td>${risk}</td>
      </tr>
    `;
  }
}

// ================== STORAGE HELPERS ==================
function saveData(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
function loadData(key){ return JSON.parse(localStorage.getItem(key)) || []; }

// ================== DASHBOARD LOADER ==================
function loadDashboard() {
  const role = roleSelect.value;
  const name = nameInput.value.trim();
  if(!role || !name) return alert("Select role and enter name");

  applyRole(role);
  dashboardContent.innerHTML = `<p>Welcome ${name} (${role})</p>`;

  if(role==="teacher") {
    const score = 100 - getTeacherScore(name);
    const payroll = calculateTeacherPayroll(name);
    const feedback = getFeedbackSummary(name);
    dashboardContent.innerHTML += `
      <p>Attendance Score: ${score}%</p>
      <p>Payroll: $${payroll}</p>
      <p>Feedback: ${feedback.positive} Positive | ${feedback.neutral} Neutral | ${feedback.negative} Negative</p>
    `;
  }

  if(role==="admin") {
    loadAbsenceOverview();
  }
}

// ================== EXPORT ATTENDANCE ==================
function exportAttendanceCSV() {
  let csv="Teacher,Student,Date,Status,Time,Notes\n";
  attendanceLog.forEach(r => {
    csv+=`${r.teacher},${r.student},${r.date},${r.status},${r.time},${r.notes}\n`;
  });
  const blob = new Blob([csv],{type:"text/csv"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="attendance_report.csv";
  link.click();
}
<!-- ================== NOTIFICATIONS PANEL ================== -->
<div id="notificationsPanel" class="position-fixed top-0 end-0 m-3" style="z-index:1050; width:300px;"></div>

<script>
// ================== NOTIFICATION SYSTEM ==================
const notifications = [];

// Add a notification
function addNotification(message, type = "info") {
  const notif = { message, type, time: new Date() };
  notifications.push(notif);
  renderNotification(notif);
}

// Render notification in dashboard
function renderNotification(notif) {
  const panel = document.getElementById("notificationsPanel");

  const div = document.createElement("div");
  div.className = `alert alert-${notif.type} alert-dismissible fade show`;
  div.role = "alert";
  div.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
  div.innerHTML = `
    ${notif.message}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    <small class="text-muted d-block">${notif.time.toLocaleTimeString()}</small>
  `;
  
  panel.appendChild(div);

  // Auto dismiss after 5 seconds
  setTimeout(() => div.remove(), 5000);
}

// ================== EVENT TRIGGERS ==================
// Trial booking event
function notifyTrialBooking(parent, student, teacher) {
  addNotification(`Trial booked: ${student} assigned to ${teacher} (Parent: ${parent})`, "success");
}

// Attendance event
function notifyAttendanceRecorded(teacher, student, status) {
  addNotification(`Attendance recorded: ${student} (${status}) - Teacher: ${teacher}`, "info");
}

// Payment event
function notifyPaymentReceived(student, amount, status) {
  addNotification(`Payment ${status}: ${student} paid $${amount}`, "warning");
}

// ================== INTEGRATION WITH EXISTING MODULE ==================
// Trigger notifications when trial is booked
document.getElementById("trialForm").addEventListener("submit", e => {
  e.preventDefault();

  const parent = parentName.value;
  const student = studentName.value;
  const assigned = autoAssignTeacher(["Teacher Ann", "Teacher John", "Teacher Lisa", "Teacher Mark"]);
  const trial = { parent, student, assignedTeacher: assigned, status: "Assigned" };
  
  trialLog.push(trial);
  saveData("trialLog", trialLog);

  trialMessage.innerHTML = `Trial booked âœ” Assigned to <b>${assigned}</b>`;
  notifyTrialBooking(parent, student, assigned);
  e.target.reset();
});

// Trigger notifications when attendance is saved
document.getElementById("attendanceForm").addEventListener("submit", e => {
  e.preventDefault();

  const record = {
    teacher: attTeacher.value,
    student: attStudent.value,
    date: attDate.value,
    status: attStatus.value,
    time: attTime.value,
    notes: attNotes.value
  };

  attendanceLog.push(record);
  saveData("attendanceLog", attendanceLog);

  updateAttendanceScore(record.teacher);
  attendanceMsg.innerText = "Attendance saved âœ”";
  notifyAttendanceRecorded(record.teacher, record.student, record.status);
  e.target.reset();
});

// Trigger notifications when payment is made
function addPayment(student, amount, status="Completed") {
  const payment = { student, amount, status, date: new Date().toLocaleDateString() };
  paymentLog.push(payment);
  saveData("paymentLog", paymentLog);
  notifyPaymentReceived(student, amount, status);
}

// ================== OPTIONAL: WEB NOTIFICATIONS ==================
if("Notification" in window) {
  Notification.requestPermission();
  function pushBrowserNotification(title, message) {
    if(Notification.permission === "granted") {
      new Notification(title, { body: message });
    }
  }
}

// Example usage: pushBrowserNotification("Trial Booked", "Student X assigned to Teacher Lisa");
</script>


</script>

</body>
</html>

